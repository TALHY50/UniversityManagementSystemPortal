@using UniversityManagementSystemPortal.Enum;
@using UniversityManagementSystemPortal.ModelDto.InstituteDto

@{
    ViewBag.Title = "Institute Index";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<h2>Institute List</h2>
<button type="button" class="btn btn-success mb-3" data-bs-toggle="modal" data-bs-target="#createInstituteModal">Create a New Institute</button>
<table id="instituteTable" class="table table-bordered table-striped">
    <thead>
        <tr>
            <th>Name</th>
            <th>Type</th>
            <th>Phone</th>
            <th>Email</th>
            <th>Website</th>
            <th>Address</th>
            <th>Auto Increment Admission No</th>
            <th>Auto Increment Employee No</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
    </tbody>
</table>
<!-- Add this code inside the index view -->
<div class="modal fade" id="createInstituteModal" tabindex="-1" aria-labelledby="createInstituteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createInstituteModalLabel">Create a New Institute</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="createInstituteForm" method="post" onsubmit="return validateForm();">

                    <input type="hidden" name="Id" id="Id" />
                    <div class="form-group mr-3">
                        <label for="Name" class="mr-2">Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control mr-2" name="Name" id="Name" placeholder="Institute Name" required />
                    </div>

                    <div class="form-group mr-3">
                        <label for="Type" class="mr-2">Type <span class="text-danger">*</span></label>
                        <select name="Type" id="Type" class="form-control mr-2">
                            <option value="">Select a type</option>
                            @foreach (var type in Enum.GetValues(typeof(InstituteType)))
                            {
                                <option value="@type">@type</option>
                            }
                        </select>
                    </div>

                    <div class="form-group icon-input-container mr-3">
                        <label for="Phone" class="mr-2">Phone <span class="text-danger">*</span></label>
                        <input type="text" class="form-control icon-input mr-2" name="Phone" id="Phone" placeholder="1234567890" required />
                        <i class="fas fa-phone input-icon"></i>
                    </div>

                    <div class="form-group icon-input-container mr-3">
                        <label for="Email" class="mr-2">Email <span class="text-danger">*</span></label>
                        <input type="email" class="form-control icon-input mr-2" name="Email" id="Email" placeholder="example@example.com" required />
                        <i class="fas fa-envelope input-icon"></i>
                    </div>

                    <div class="form-group icon-input-container mr-3">
                        <label for="Website" class="mr-2">Website</label>
                        <input type="url" class="form-control icon-input mr-2" name="Website" id="Website" placeholder="https://example.com" />
                        <i class="fas fa-globe input-icon"></i>
                    </div>

                    <div class="form-group mr-3">
                        <label for="Address" class="mr-2">Address</label>
                        <input type="text" class="form-control mr-2" name="Address" id="Address" placeholder="123 Main St, City, Country" />
                    </div>

                    <div class="form-group form-check mr-3">
                        <input type="checkbox" name="IsAutoIncrementAdmissionNo" id="IsAutoIncrementAdmissionNo" class="form-check-input" />
                        <label for="IsAutoIncrementAdmissionNo" class="form-check-label mr-2">Auto Increment Admission No</label>
                    </div>

                    <div class="form-group form-check mr-3">
                        <input type="checkbox" name="IsAutoIncrementEmployeeNo" id="IsAutoIncrementEmployeeNo" class="form-check-input" />
                        <label for="IsAutoIncrementEmployeeNo" class="form-check-label mr-2">Auto Increment Employee No</label>
                    </div>
                </form>

            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="submitInstitute">Save changes</button>
            </div>
        </div>
    </div>
</div>
@section Scripts {
    <script>
     

        $(document).ready(function () {
            var table = $('#instituteTable').DataTable();

            // Load the institute data using AJAX
            loadInstituteData();

            function loadInstituteData() {
                $.ajax({
                    url: '@Url.Action("GetInstitutes", "Institute")',
                    type: 'GET',
                    dataType: 'json',
                    success: function (institutes) {
                        table.clear();
                        $.each(institutes, function (i, institute) {
                            addInstituteToTable(institute);
                        });
                        table.draw();
                    },
                    error: function () {
                        alert('Error while loading institute data. Please try again.');
                    }
                });
            }
            function addInstituteToTable(institute) {
                table.row.add([
                    institute.name,
                    institute.type,
                    institute.phone,
                    institute.email,
                    institute.website,
                    institute.address,
                    institute.isAutoIncrementAdmissionNo ? 'Yes' : 'No',
                    institute.isAutoIncrementEmployeeNo ? 'Yes' : 'No',
                    '<button type="button" class="btn btn-primary" onclick="openUpdateModal(\'' + institute.id + '\', \'' + institute.name + '\', \'' + institute.type + '\', \'' + institute.phone + '\', \'' + institute.email + '\', \'' + institute.website + '\', \'' + institute.address + '\', ' + institute.isAutoIncrementAdmissionNo + ', ' + institute.isAutoIncrementEmployeeNo + ')">Edit</button>' +
                    '<button type="button" class="btn btn-danger" onclick="deleteInstitute(\'' + institute.id + '\')">Delete</button>'
                ]).draw();
            }


            $('#submitInstitute').click(function (e) {
                e.preventDefault();

                var instituteId = $('#Id').val();

                if (instituteId === '') {
                    createInstitute();
                } else {
                    updateInstitute(instituteId);
                }
            });

            function createInstitute() {
                $.ajax({
                    url: '@Url.Action("Create", "Institute")',
                    type: 'POST',
                    data: $('#createInstituteForm').serialize(),
                    dataType: 'json',
                    success: function (response) {
                        if (response.success) {
                            loadInstituteData()
                            $('#createInstituteModal').modal('hide');
                        } else {
                            alert(response.error);
                        }
                    },
                    error: function () {
                        alert('Error while creating institute. Please try again.');
                    }
                });
            }
            function updateInstitute(id) {
                $.ajax({
                    url: '@Url.Action("Update", "Institute")',
                    type: 'PUT',
                    data: $('#createInstituteForm').serialize(),
                    dataType: 'json',
                    success: function (response) {
                        if (response.success) {
                            loadInstituteData();
                            $('#createInstituteModal').modal('hide');
                        } else {
                            alert(response.error);
                        }
                    },
                    error: function () {
                        alert('Error while updating institute. Please try again.');
                    }
                });
            }
            window.deleteInstitute = function (id) {
                if (confirm('Are you sure you want to delete this institute?')) {
                    $.ajax({
                        url: '@Url.Action("Delete", "Institute")/' + id,
                        type: 'POST',
                        success: function (response) {
                            if (response.success) {
                                loadInstituteData();
                            } else {
                                alert(response.error);
                            }
                        },
                        error: function () {
                            alert('Error while deleting institute. Please try again.');
                        }
                    });
                }
            }
            window.openUpdateModal = function (id, name, type, phone, email, website, address, isAutoIncrementAdmissionNo, isAutoIncrementEmployeeNo) {
                $('#Id').val(id);
                $('#Name').val(name);
                $('#Type').val(type.toString()); // Convert the enum
                $('#Phone').val(phone);
                $('#Email').val(email);
                $('#Website').val(website);
                $('#Address').val(address);
                $('#IsAutoIncrementAdmissionNo').prop('checked', isAutoIncrementAdmissionNo);
                $('#IsAutoIncrementEmployeeNo').prop('checked', isAutoIncrementEmployeeNo);
                $('#createInstituteModal').modal('show');
            }

            function openCreateModal() {
                $('#createInstituteForm')[0].reset();
                $('#Id').val('');
                $('#createInstituteModal').modal('show');
            }

            // Event listener for the 'Create' button
            document.querySelector('.btn-success').addEventListener('click', openCreateModal);
        });

    </script>
}